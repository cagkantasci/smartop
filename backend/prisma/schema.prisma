// Smartop Database Schema
// PostgreSQL 16+ with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionTier {
  starter
  professional
  enterprise
}

enum SubscriptionStatus {
  active
  past_due
  cancelled
  trial
}

enum UserRole {
  admin
  manager
  operator
}

enum MachineType {
  excavator
  dozer
  crane
  loader
  truck
  grader
  roller
  forklift
  backhoe
  skid_steer
  telehandler
  compactor
  paver
  trencher
  drill
  generator
  compressor
  concrete_equipment
  lift
  trailer
  scraper
  other
}

enum MachineStatus {
  active
  idle
  maintenance
  out_of_service
}

enum ChecklistStatus {
  pending
  approved
  rejected
}

enum JobStatus {
  scheduled
  in_progress
  completed
  cancelled
  delayed
}

enum JobPriority {
  low
  medium
  high
  urgent
}

enum ServiceType {
  maintenance
  repair
  inspection
  oil_change
  tire_change
  other
}

enum InvoiceStatus {
  draft
  pending
  paid
  overdue
  cancelled
}

// ============================================
// ORGANIZATIONS (Multi-tenant root)
// ============================================
model Organization {
  id                 String             @id @default(uuid())
  name               String
  slug               String             @unique
  taxNumber          String?            @map("tax_number")
  taxOffice          String?            @map("tax_office")
  phone              String?
  email              String?
  address            String?
  logoUrl            String?            @map("logo_url")
  subscriptionTier   SubscriptionTier   @default(starter) @map("subscription_tier")
  subscriptionStatus SubscriptionStatus @default(active) @map("subscription_status")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  settings           Json               @default("{}")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  users                 User[]
  machines              Machine[]
  checklistTemplates    ChecklistTemplate[]
  checklistSubmissions  ChecklistSubmission[]
  jobs                  Job[]
  serviceRecords        ServiceRecord[]
  invoices              Invoice[]
  notifications         Notification[]
  auditLogs             AuditLog[]

  @@map("organizations")
}

// ============================================
// USERS
// ============================================
model User {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  email           String
  passwordHash    String?   @map("password_hash")
  role            UserRole  @default(operator)
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  phone           String?
  avatarUrl       String?   @map("avatar_url")
  jobTitle        String?   @map("job_title")
  licenses        String[]  @default([])
  specialties     String[]  @default([])
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  emailVerifiedAt DateTime? @map("email_verified_at")
  // Location tracking for operators (live tracking)
  locationLat          Decimal?  @map("location_lat") @db.Decimal(10, 8)
  locationLng          Decimal?  @map("location_lng") @db.Decimal(11, 8)
  locationAddress      String?   @map("location_address")
  locationUpdatedAt    DateTime? @map("location_updated_at")
  // 2FA / Biometric settings
  twoFactorEnabled     Boolean   @default(false) @map("two_factor_enabled")
  biometricEnabled     Boolean   @default(false) @map("biometric_enabled")
  // Notification settings
  pushEnabled                Boolean   @default(true) @map("push_enabled")
  emailEnabled               Boolean   @default(true) @map("email_enabled")
  smsEnabled                 Boolean   @default(false) @map("sms_enabled")
  checklistReminderEnabled   Boolean   @default(true) @map("checklist_reminder_enabled")
  jobUpdatesEnabled          Boolean   @default(true) @map("job_updates_enabled")
  maintenanceAlertsEnabled   Boolean   @default(true) @map("maintenance_alerts_enabled")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  organization          Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedMachines      Machine[]             @relation("AssignedOperator")
  checklistSubmissions  ChecklistSubmission[] @relation("OperatorSubmissions")
  reviewedSubmissions   ChecklistSubmission[] @relation("ReviewerSubmissions")
  createdTemplates      ChecklistTemplate[]
  createdJobs           Job[]
  serviceRecords        ServiceRecord[]
  notifications         Notification[]
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]
  jobAssignments        JobAssignment[]
  passwordResetTokens   PasswordResetToken[]
  deviceTokens          DeviceToken[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@map("users")
}

// ============================================
// MACHINES
// ============================================
model Machine {
  id                   String        @id @default(uuid())
  organizationId       String        @map("organization_id")
  name                 String
  brand                String?
  model                String?
  year                 Int?
  machineType          MachineType   @map("machine_type")
  serialNumber         String?       @map("serial_number")
  licensePlate         String?       @map("license_plate")
  status               MachineStatus @default(active)
  engineHours          Decimal       @default(0) @map("engine_hours") @db.Decimal(10, 2)
  odometer             Decimal       @default(0) @db.Decimal(12, 2)
  fuelType             String?       @map("fuel_type")
  fuelCapacity         Decimal?      @map("fuel_capacity") @db.Decimal(8, 2)
  lastServiceDate      DateTime?     @map("last_service_date") @db.Date
  nextServiceDate      DateTime?     @map("next_service_date") @db.Date
  nextServiceHours     Decimal?      @map("next_service_hours") @db.Decimal(10, 2)
  imageUrl             String?       @map("image_url")
  locationLat          Decimal?      @map("location_lat") @db.Decimal(10, 8)
  locationLng          Decimal?      @map("location_lng") @db.Decimal(11, 8)
  locationAddress      String?       @map("location_address")
  locationUpdatedAt    DateTime?     @map("location_updated_at")
  assignedOperatorId   String?       @map("assigned_operator_id")
  checklistTemplateId  String?       @map("checklist_template_id")
  notes                String?
  metadata             Json          @default("{}")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  // Relations
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedOperator     User?                 @relation("AssignedOperator", fields: [assignedOperatorId], references: [id], onDelete: SetNull)
  checklistTemplate    ChecklistTemplate?    @relation(fields: [checklistTemplateId], references: [id], onDelete: SetNull)
  checklistSubmissions ChecklistSubmission[]
  serviceRecords       ServiceRecord[]
  jobAssignments       JobAssignment[]

  @@unique([organizationId, serialNumber])
  @@index([organizationId])
  @@index([status])
  @@index([assignedOperatorId])
  @@map("machines")
}

// ============================================
// CHECKLIST TEMPLATES
// ============================================
model ChecklistTemplate {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  name           String
  description    String?
  machineTypes   String[]    @default([]) @map("machine_types")
  items          Json        @default("[]") // [{id, label, type, required}]
  isActive       Boolean     @default(true) @map("is_active")
  createdById    String?     @map("created_by")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  organization          Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy             User?                 @relation(fields: [createdById], references: [id])
  machines              Machine[]
  checklistSubmissions  ChecklistSubmission[]

  @@map("checklist_templates")
}

// ============================================
// CHECKLIST SUBMISSIONS
// ============================================
model ChecklistSubmission {
  id             String          @id @default(uuid())
  organizationId String          @map("organization_id")
  machineId      String          @map("machine_id")
  templateId     String          @map("template_id")
  operatorId     String          @map("operator_id")
  status         ChecklistStatus @default(pending)
  entries        Json            @default("[]") // [{item_id, label, is_ok, value, photo_url}]
  issuesCount    Int             @default(0) @map("issues_count")
  notes          String?
  startHours     Decimal?        @map("start_hours") @db.Decimal(10, 1)
  endHours       Decimal?        @map("end_hours") @db.Decimal(10, 1)
  locationLat    Decimal?        @map("location_lat") @db.Decimal(10, 8)
  locationLng    Decimal?        @map("location_lng") @db.Decimal(11, 8)
  submittedAt    DateTime        @default(now()) @map("submitted_at")
  reviewedAt     DateTime?       @map("reviewed_at")
  reviewerId     String?         @map("reviewer_id")
  reviewerNotes  String?         @map("reviewer_notes")
  createdAt      DateTime        @default(now()) @map("created_at")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  machine      Machine           @relation(fields: [machineId], references: [id], onDelete: Cascade)
  template     ChecklistTemplate @relation(fields: [templateId], references: [id])
  operator     User              @relation("OperatorSubmissions", fields: [operatorId], references: [id])
  reviewer     User?             @relation("ReviewerSubmissions", fields: [reviewerId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([machineId])
  @@index([submittedAt])
  @@map("checklist_submissions")
}

// ============================================
// JOBS / WORK ORDERS
// ============================================
model Job {
  id              String      @id @default(uuid())
  organizationId  String      @map("organization_id")
  title           String
  description     String?
  locationName    String?     @map("location_name")
  locationLat     Decimal?    @map("location_lat") @db.Decimal(10, 8)
  locationLng     Decimal?    @map("location_lng") @db.Decimal(11, 8)
  locationAddress String?     @map("location_address")
  status          JobStatus   @default(scheduled)
  priority        JobPriority @default(medium)
  progress        Int         @default(0)
  scheduledStart  DateTime?   @map("scheduled_start") @db.Date
  scheduledEnd    DateTime?   @map("scheduled_end") @db.Date
  actualStart     DateTime?   @map("actual_start")
  actualEnd       DateTime?   @map("actual_end")
  estimatedHours  Decimal?    @map("estimated_hours") @db.Decimal(8, 2)
  actualHours     Decimal?    @map("actual_hours") @db.Decimal(8, 2)
  createdById     String?     @map("created_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User?           @relation(fields: [createdById], references: [id])
  jobAssignments  JobAssignment[]

  @@index([organizationId])
  @@index([status])
  @@map("jobs")
}

// ============================================
// JOB ASSIGNMENTS (Many-to-Many)
// ============================================
model JobAssignment {
  id                String    @id @default(uuid())
  jobId             String    @map("job_id")
  machineId         String?   @map("machine_id")
  operatorId        String?   @map("operator_id")
  assignedAt        DateTime  @default(now()) @map("assigned_at")
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  startMeterReading Decimal?  @map("start_meter_reading") @db.Decimal(12, 2)
  endMeterReading   Decimal?  @map("end_meter_reading") @db.Decimal(12, 2)
  notes             String?

  // Relations
  job      Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  machine  Machine? @relation(fields: [machineId], references: [id], onDelete: SetNull)
  operator User?    @relation(fields: [operatorId], references: [id], onDelete: SetNull)

  @@unique([jobId, machineId])
  @@map("job_assignments")
}

// ============================================
// SERVICE RECORDS
// ============================================
model ServiceRecord {
  id               String      @id @default(uuid())
  organizationId   String      @map("organization_id")
  machineId        String      @map("machine_id")
  serviceType      ServiceType @map("service_type")
  description      String
  performedBy      String?     @map("performed_by")
  vendor           String?
  cost             Decimal?    @db.Decimal(12, 2)
  currency         String      @default("TRY")
  partsUsed        Json        @default("[]") @map("parts_used")
  meterReading     Decimal?    @map("meter_reading") @db.Decimal(12, 2)
  serviceDate      DateTime    @map("service_date") @db.Date
  nextServiceDate  DateTime?   @map("next_service_date") @db.Date
  nextServiceHours Decimal?    @map("next_service_hours") @db.Decimal(10, 2)
  attachments      String[]    @default([])
  notes            String?
  createdById      String?     @map("created_by")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  machine      Machine      @relation(fields: [machineId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdById], references: [id])

  @@index([machineId])
  @@map("service_records")
}

// ============================================
// INVOICES
// ============================================
model Invoice {
  id                 String        @id @default(uuid())
  organizationId     String        @map("organization_id")
  invoiceNumber      String        @unique @map("invoice_number")
  amount             Decimal       @db.Decimal(12, 2)
  currency           String        @default("TRY")
  status             InvoiceStatus @default(pending)
  description        String?
  lineItems          Json          @default("[]") @map("line_items")
  billingPeriodStart DateTime?     @map("billing_period_start") @db.Date
  billingPeriodEnd   DateTime?     @map("billing_period_end") @db.Date
  issueDate          DateTime      @map("issue_date") @db.Date
  dueDate            DateTime      @map("due_date") @db.Date
  paidAt             DateTime?     @map("paid_at")
  paymentMethod      String?       @map("payment_method")
  stripeInvoiceId    String?       @map("stripe_invoice_id")
  pdfUrl             String?       @map("pdf_url")
  notes              String?
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@map("invoices")
}

// ============================================
// NOTIFICATIONS
// ============================================
model Notification {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  type           String
  title          String
  body           String?
  data           Json     @default("{}")
  isRead         Boolean  @default(false) @map("is_read")
  readAt         DateTime? @map("read_at")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ============================================
// AUDIT LOG
// ============================================
model AuditLog {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  userId         String?  @map("user_id")
  action         String
  entityType     String?  @map("entity_type")
  entityId       String?  @map("entity_id")
  oldValues      Json?    @map("old_values")
  newValues      Json?    @map("new_values")
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ============================================
// DEVICE TOKENS (FCM Push Notifications)
// ============================================
enum DevicePlatform {
  ios
  android
  web
}

model DeviceToken {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  token          String         // FCM or Expo push token
  platform       DevicePlatform
  deviceName     String?        @map("device_name")
  deviceModel    String?        @map("device_model")
  appVersion     String?        @map("app_version")
  isActive       Boolean        @default(true) @map("is_active")
  lastUsedAt     DateTime       @default(now()) @map("last_used_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId, isActive])
  @@index([token])
  @@map("device_tokens")
}

// ============================================
// REFRESH TOKENS
// ============================================
model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// PASSWORD RESET TOKENS
// ============================================
model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@map("password_reset_tokens")
}

// ============================================
// MACHINE REFERENCE DATA (Global - Not tenant-specific)
// ============================================

// Machine Categories (Excavators, Loaders, Cranes, etc.)
model MachineCategory {
  id          String   @id @default(uuid())
  name        String   // Display name (e.g., "Excavators")
  nameEn      String   @map("name_en") // English name
  nameTr      String?  @map("name_tr") // Turkish name
  slug        String   @unique // URL-friendly identifier (e.g., "excavators")
  parentId    String?  @map("parent_id") // For subcategories
  description String?
  iconName    String?  @map("icon_name") // Icon identifier for UI
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  parent      MachineCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    MachineCategory[] @relation("CategoryHierarchy")
  models      MachineModel[]

  @@index([parentId])
  @@index([slug])
  @@map("machine_categories")
}

// Machine Brands/Manufacturers (Caterpillar, Komatsu, Volvo, etc.)
model MachineBrand {
  id          String   @id @default(uuid())
  name        String   // Display name (e.g., "CATERPILLAR")
  slug        String   @unique // URL-friendly identifier (e.g., "caterpillar")
  logoUrl     String?  @map("logo_url")
  website     String?
  country     String?  // Country of origin
  description String?
  isPopular   Boolean  @default(false) @map("is_popular") // For showing popular brands first
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  models MachineModel[]

  @@index([slug])
  @@index([isPopular])
  @@map("machine_brands")
}

// Machine Models (specific machine models from brands)
model MachineModel {
  id                String   @id @default(uuid())
  brandId           String   @map("brand_id")
  categoryId        String?  @map("category_id")
  name              String   // Model name (e.g., "320D", "PC200-8")
  fullName          String?  @map("full_name") // Full display name
  yearStart         Int?     @map("year_start") // Production start year
  yearEnd           Int?     @map("year_end") // Production end year (null if still in production)
  enginePower       String?  @map("engine_power") // e.g., "147 HP"
  operatingWeight   String?  @map("operating_weight") // e.g., "20,000 kg"
  specifications    Json     @default("{}") // Additional specs
  imageUrl          String?  @map("image_url")
  sourceUrl         String?  @map("source_url") // Where the data was scraped from
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  brand    MachineBrand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category MachineCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([brandId, name])
  @@index([brandId])
  @@index([categoryId])
  @@index([name])
  @@map("machine_models")
}
